{% load static menu_tags i18n wagtailimages_tags home_tags image_tags generic_components %}

{% get_current_language as LANGUAGE_CODE %}
{% get_language_info for LANGUAGE_CODE as lang %}
{% get_available_languages as LANGUAGES %}
{% get_language_info_list for LANGUAGES as languages %}
{% load notifications_tags %}
<header id="header" style="background: {{ settings.home.ThemeSettings.header_background_color }}">
    <div class="header-holder">
        <div class="header-content">
            <div class="logo-holder">
                <a href="{% translated_home_page_url LANGUAGE_CODE %}">
                    {% image settings.home.SiteSettings.logo width-120 class='xs-image' %}
                </a>
            </div>
            <div class="language__select">
                {% language_switcher page %}
            </div>
            {% if request.user.is_authenticated %}
            <div class="notification-holder">
                <div class="notification-bell-wrapper" onclick="openNotificationsPanel()" style="cursor: pointer;">
                    <div class="notification-bell" onclick="openNotificationsPanel()">
                        <svg id="notif-bell" style="width: 30px; height:28px; fill: #FDD256;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M320 64C302.3 64 288 78.3 288 96L288 99.2C215 114 160 178.6 160 256L160 277.7C160 325.8 143.6 372.5 113.6 410.1L103.8 422.3C98.7 428.6 96 436.4 96 444.5C96 464.1 111.9 480 131.5 480L508.4 480C528 480 543.9 464.1 543.9 444.5C543.9 436.4 541.2 428.6 536.1 422.3L526.3 410.1C496.4 372.5 480 325.8 480 277.7L480 256C480 178.6 425 114 352 99.2L352 96C352 78.3 337.7 64 320 64zM258 528C265.1 555.6 290.2 576 320 576C349.8 576 374.9 555.6 382 528L258 528z"/></svg>
                        <span id="notif-count" class="notif-badge" style="display: none;">{{ request.user.notifications.unread.count }}</span>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        <div class="form-holder search-form-holder">
            <a class="js-search-btn" href="{% url 'search' %}">
                {% render_icon icon_path='icons/search.svg' attrs="alt='Search' class='xs-home-header__search'" %}
            </a>
            <form class='search__form' action="{% url 'search' %}">
                <label>
                    <span>
                        {% render_icon icon_path='icons/search.svg' width=18 height=18 stroke_color='#9A9A9A' %}
                    </span>
                    <input type="text" name="query" placeholder="{% translate 'Search the site...' %}"
                        pattern="\S+.*" />
                </label>
            </form>
        </div>
        <div class="btn-holder">
            <div class="nav-bar__item">
                {% url 'account_login' as login_url %}
                {% if request.user.is_anonymous %}
                {% primary_button title="Log in / Create account" href=login_url icon_path='icons/login.svg' extra_classnames='login-create-account-btn' %}
                {% else %}
                {% url 'user_profile' as profile_url %}
                {% primary_button title="Profile" href=profile_url icon_path='icons/profile.svg' %}
                {% endif %}
            </div>
        </div>
    </div>
</header>
{% if user.is_authenticated %}
<script>
    function refreshUnreadCount() {
        fetch("{% url 'user_notifications:unread_count' %}")
            .then(res => res.json())
            .then(data => {
                const countEl = document.getElementById("notif-count");
                const bell = document.getElementById("notif-bell");
                if (data.unread_count > 0) {
                    countEl.innerText = data.unread_count > 99 ? "99+" : data.unread_count;
                    countEl.style.display = "inline-block";
                    bell.classList.add("highlighted");
                } else {
                    countEl.style.display = "none";
                    bell.classList.remove("highlighted");
                }
            })
            .catch(err => console.warn("⚠️ Failed to fetch unread count", err));
    }

    document.addEventListener("DOMContentLoaded", function () {
        refreshUnreadCount();                    // run it once when page loads
        setInterval(refreshUnreadCount, 15000);  // then every 15 seconds
    });

    function openNotificationsPanel() {
        document.querySelector('.notification-panel').style.display = 'block';
        document.getElementById('notification-overlay').style.display = 'block';
        fetch('{% url "user_notifications:latest_notifications" %}').then(
            res => res.text()
        ).then(html => {
            document.getElementById('notification-list').innerHTML = html;
            markNotificationsAsRead();
        });
    }

    function closeNotificationsPanel() {
        document.querySelector('.notification-panel').style.display = 'none';
        document.getElementById('notification-overlay').style.display = 'none';
    }

    function markNotificationsAsRead() {
        const ids = Array.from(document.querySelectorAll('.notification-item.unread')).map(el => el.dataset.id);
        if (ids.length === 0) return;
        const query = new URLSearchParams();
        ids.forEach(id => query.append('ids[]', id));
        const url = `{% url 'user_notifications:mark_selected_read' %}?${query.toString()}`;

        fetch(url).then(response => response.json()).then(data => {
            refreshUnreadCount();
         });
    }
function handleNotificationClick(event, element) {
    event.preventDefault();
    const notifId = element.getAttribute("data-id");
    const notifUrl = element.getAttribute("data-url");
    if (!notifUrl || notifUrl === "#") {
        console.warn("❌ Invalid or missing notification URL:", notifUrl);
        return;
    }
    const clickUrlTemplate = "{% url 'user_notifications:mark_notification_clicked' 0 %}";
    const clickUrl = clickUrlTemplate.replace("0", notifId);
    element.classList.add('clicked');
    fetch(clickUrl, {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
        },
    }).then(() => {
        window.location.href = notifUrl;  // or window.open(notifUrl, "_blank");
    }).catch((err) => {
        console.error("Error marking as clicked:", err);
        window.location.href = notifUrl;
    });
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}


</script>
{% endif %}