{% load track %}

{% if tracking_enabled %}
  {% matomo_all_lang_vars page as mvars %}

  <script>
    async function hashEmail(email) {
      const encoder = new TextEncoder();
      const data = encoder.encode(email);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hashBuffer))
                  .map(b => b.toString(16).padStart(2, '0'))
                  .join('');
    }
  </script>

  <script>
    var _paq = window._paq = window._paq || [];

    // 1) Normal language-specific tracking (keeps your current per-language rows)
    _paq.push(['setCustomUrl', window.location.href]);
    _paq.push(['setDocumentTitle', document.title]);
    // add page group ID:
    _paq.push(['setCustomDimension', 1, '{{ page.translation_key }}']);
    _paq.push(['trackPageView']);

    // 2) All_Lang tracking based purely on translation_key (NO URL parsing)
    (function() {
      // We donâ€™t rely on the real URL at all here
      var allLangUrl   = "{{ mvars.url|escapejs }}";      // /all_lang/<translation_key>/
      var allLangTitle = "All_Lang: {{ mvars.title|escapejs }}";
      var pageGroupId  = "{{ mvars.key|escapejs }}";      // translation_key

      // Use a synthetic, stable URL that is the same for all languages
      _paq.push(['setCustomUrl', allLangUrl]);
      _paq.push(['setDocumentTitle', allLangTitle]);

      // OPTIONAL BUT RECOMMENDED:
      // Create a Page-scope Custom Dimension in Matomo (e.g., ID=1) called "Page Group ID"
      // and send the translation_key into it.
      _paq.push(['setCustomDimension', 1, pageGroupId]);

      // This second hit will be ONE single row in the "Pages" report
      // because URL and title are identical for all translations.
      _paq.push(['trackPageView']);
    })();

    _paq.push(['enableLinkTracking']);

    {% if user_id %}
      hashEmail("{{ user_id|escapejs }}").then(function(hashedEmail) {
        if (window._paq) {
          _paq.push(['setUserId', hashedEmail]);
        }
      });
    {% endif %}

    (function() {
      var u = "{{ matomo_server_url }}";
      _paq.push(['setTrackerUrl', u + 'matomo.php']);
      _paq.push(['setSiteId', '{{ matomo_site_id }}']);

      var d = document, g = d.createElement('script'), s = d.getElementsByTagName('script')[0];
      g.type='text/javascript';
      g.async = true;
      g.src = u + 'matomo.js';
      s.parentNode.insertBefore(g, s);
    })();
  </script>

  <noscript>
    <img src="{{ matomo_image_tracker_url }}" style="border:0" alt="" />
    {% if matomo_additional_image_tracker_url %}
      <img src="{{ matomo_additional_image_tracker_url }}" style="border:0" alt="" />
    {% endif %}
  </noscript>
{% endif %}
