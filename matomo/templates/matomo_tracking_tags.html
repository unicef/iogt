{% load track %}

{% if tracking_enabled %}
  {% matomo_all_lang_vars page as mvars %}

  <script>
    async function hashEmail(email) { /* ... unchanged ... */ }
  </script>

  <script>
    var _paq = window._paq = window._paq || [];

    // (A) Normal per-language tracking
    _paq.push(['setCustomUrl', window.location.href]);
    _paq.push(['setDocumentTitle', document.title]);
    _paq.push(['setCustomDimension', 1, '{{ page.translation_key|default_if_none:"" }}']);
    _paq.push(['trackPageView']);

    // (B) All_Lang synthetic hit â€” only if we have a translation_key
    {% if mvars.available %}
    (function() {
      var allLangUrl   = "{{ mvars.url|escapejs }}";      // /all_lang/<translation_key>/
      var allLangTitle = "All_Lang: {{ mvars.title|escapejs }}";
      var pageGroupId  = "{{ mvars.key|escapejs }}";      // translation_key

      _paq.push(['setCustomUrl', allLangUrl]);
      _paq.push(['setDocumentTitle', allLangTitle]);
      _paq.push(['setCustomDimension', 1, pageGroupId]);
      _paq.push(['trackPageView']);
    })();
    {% endif %}

    _paq.push(['enableLinkTracking']);

    {% if user_id %}
      hashEmail("{{ user_id|escapejs }}").then(function(hashedEmail) {
        if (window._paq) { _paq.push(['setUserId', hashedEmail]); }
      });
    {% endif %}

    (function() {
      var u = "{{ matomo_server_url }}";
      _paq.push(['setTrackerUrl', u + 'matomo.php']);
      _paq.push(['setSiteId', '{{ matomo_site_id }}']);
      var d=document,g=d.createElement('script'),s=d.getElementsByTagName('script')[0];
      g.type='text/javascript'; g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
    })();
  </script>

  <noscript>
    <img src="{{ matomo_image_tracker_url }}" style="border:0" alt="" />
    {% if matomo_additional_image_tracker_url %}
      <img src="{{ matomo_additional_image_tracker_url }}" style="border:0" alt="" />
    {% endif %}
  </noscript>
{% endif %}
