<!-- Matomo -->
<script>
 async function hashEmail(email) {
    const encoder = new TextEncoder();
    const data = encoder.encode(email);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hashBuffer))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
}
</script>
<script>
    function canonicalizePathname(pathname) {
        // Split and check first segment after "/"
        const parts = pathname.split('/');
        if (parts.length > 1) {
            const seg = parts[1];

            // Match lang codes: en, fr, prs, en-US, pt_BR, etc.
            const langLike = /^([a-z]{2,3})([-_][a-z]{2})?$/i;

            if (langLike.test(seg) && seg.toLowerCase() !== 'all_lang') {
                parts[1] = 'all_lang';
                return parts.join('/');
            }
        }
        return pathname;
    }
</script>
{% if tracking_enabled %}
    <script>
        var _paq = window._paq = window._paq || [];
        /* Tracker methods like "setCustomDimension" should be called before "trackPageView" */
        var randValue = Math.floor(Math.random() * 1000000000);  // Random value for cache prevention
        var apivParam = '&apiv=1&rand=' + randValue;

        // Build canonical "All_Lang" URL (same origin, normalized path)
        (function(){
            var origin = window.location.origin || (window.location.protocol + '//' + window.location.host);
            var canonicalPath = canonicalizePathname(window.location.pathname);
            var allLangUrl = origin + canonicalPath + window.location.search + window.location.hash;

            // IMPORTANT: set the Action-scoped custom dimension BEFORE trackPageView
            // (Use the same ID you created in Matomo)
            _paq.push(['setCustomDimension', {{ settings.MATOMO_CANONICAL_DIMENSION_ID|default:1 }}, allLangUrl]);
        })();

        _paq.push(['setDocumentTitle', document.title]);
        _paq.push(['setCustomUrl', window.location.href]);
        _paq.push(['trackPageView']);
        _paq.push(['enableLinkTracking']);

         {% if user_id %}
            hashEmail("{{ user_id|escapejs }}").then(hashedEmail => {
                console.log(hashedEmail);
                if (window._paq) {
                _paq.push(['setUserId', hashedEmail]);
                } else {
                console.error('Matomo _paq not initialized');
                }
            });
         {% endif %}

        (function() {
            var u = "{{ matomo_server_url }}";
<!--            var u = "https://unisitetracker.unicef.io/";-->

            _paq.push(['setTrackerUrl', u + 'matomo.php']);
            _paq.push(['setSiteId', '{{ matomo_site_id }}']);

            var randValue = Math.floor(Math.random() * 1000000000);  // Random value for cache prevention

            var d = document, g = d.createElement('script'), s = d.getElementsByTagName('script')[0];
            g.async = true; 
            g.type='text/javascript'; g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
        })();
    </script>

    <noscript>
        <img src="{{ matomo_image_tracker_url }}" style="border:0" alt="" />
        {% if matomo_additional_image_tracker_url %}
        <img src="{{ matomo_additional_image_tracker_url }}" style="border:0" alt="" />
        {% endif %}
    </noscript>
{% endif %}
<!-- End Matomo Code -->
